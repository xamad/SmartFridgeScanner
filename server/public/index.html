<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Fridge - Gestione Inventario</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2196F3; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 2em; color: #333; }
        .stat-card p { color: #666; margin-top: 5px; }
        .stat-card.warning h3 { color: #ff9800; }
        .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section h2 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; }
        tr:hover { background: #f5f5f5; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .badge-danger { background: #ffebee; color: #c62828; }
        .badge-warning { background: #fff3e0; color: #ef6c00; }
        .badge-success { background: #e8f5e9; color: #2e7d32; }
        .badge-info { background: #e3f2fd; color: #1565c0; }
        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .btn-danger { background: #f44336; color: white; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn:hover { opacity: 0.9; }
        .thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .thumbnail:hover { transform: scale(1.1); }
        .no-img { width: 50px; height: 50px; background: #eee; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal img { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-row input, .form-row select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; min-width: 150px; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .refresh-btn { float: right; }
        .btn-edit { background: #ff9800; color: white; margin-right: 5px; }
        .action-btns { display: flex; gap: 5px; }
        .editable { cursor: pointer; padding: 2px 5px; border-radius: 3px; }
        .editable:hover { background: #e3f2fd; }
        input.inline-edit { padding: 4px; border: 1px solid #2196F3; border-radius: 3px; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßä Smart Fridge <button class="btn btn-primary refresh-btn" onclick="loadAll()">üîÑ Aggiorna</button></h1>

        <div class="stats">
            <div class="stat-card">
                <h3 id="total-products">-</h3>
                <p>Prodotti in frigo</p>
            </div>
            <div class="stat-card warning">
                <h3 id="expiring-soon">-</h3>
                <p>In scadenza (7 giorni)</p>
            </div>
            <div class="stat-card">
                <h3 id="shopping-items">-</h3>
                <p>Lista della spesa</p>
            </div>
        </div>

        <div class="section">
            <h2>‚ûï Aggiungi Prodotto Manuale</h2>
            <form id="add-form" class="form-row">
                <input type="text" id="add-barcode" placeholder="Barcode *" required>
                <input type="text" id="add-name" placeholder="Nome prodotto">
                <input type="text" id="add-brand" placeholder="Marca">
                <input type="date" id="add-expiry" placeholder="Scadenza">
                <input type="number" id="add-qty" placeholder="Qt√†" value="1" min="1" style="max-width:80px">
                <button type="submit" class="btn btn-primary">Aggiungi</button>
            </form>
        </div>

        <div class="section">
            <h2>üì¶ Inventario</h2>
            <table>
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>Barcode</th>
                        <th>Nome</th>
                        <th>Marca</th>
                        <th>Peso</th>
                        <th>Qt√†</th>
                        <th>Acquisto</th>
                        <th>Scadenza</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="inventory-table"></tbody>
            </table>
        </div>

        <!-- Modal per immagine ingrandita -->
        <div id="image-modal" class="modal" onclick="closeModal()">
            <span class="modal-close">&times;</span>
            <img id="modal-img" src="" alt="Prodotto">
        </div>

        <div class="section">
            <h2>‚ö†Ô∏è Prodotti in Scadenza</h2>
            <table>
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Nome</th>
                        <th>Scadenza</th>
                        <th>Stato</th>
                    </tr>
                </thead>
                <tbody id="expiring-table"></tbody>
            </table>
        </div>

        <div class="section">
            <h2>üõí Lista della Spesa</h2>
            <form id="shopping-form" class="form-row">
                <input type="text" id="shop-name" placeholder="Nome prodotto *" required>
                <input type="number" id="shop-qty" placeholder="Qt√†" value="1" min="1" style="max-width:80px">
                <button type="submit" class="btn btn-primary">+ Aggiungi alla lista</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Prodotto</th>
                        <th>Qt√†</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="shopping-table"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API = '/api';

        async function fetchJSON(url) {
            const res = await fetch(API + url);
            return res.json();
        }

        async function loadStats() {
            const stats = await fetchJSON('/stats');
            document.getElementById('total-products').textContent = stats.total_products;
            document.getElementById('expiring-soon').textContent = stats.expiring_soon;
            document.getElementById('shopping-items').textContent = stats.shopping_items;
        }

        async function loadInventory() {
            const data = await fetchJSON('/inventory');
            const tbody = document.getElementById('inventory-table');
            if (!data.products.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty">Nessun prodotto</td></tr>';
                return;
            }
            tbody.innerHTML = data.products.map(p => {
                const imgHtml = p.image_path
                    ? `<img class="thumbnail" src="${p.image_path}" onclick="openModal('${p.image_path}')" alt="${p.name || p.barcode}">`
                    : `<div class="no-img">üì¶</div>`;
                const receiptBadge = p.from_receipt ? '<span class="badge badge-info" title="Da scontrino">üßæ</span> ' : '';
                return `
                    <tr data-id="${p.id}">
                        <td>${imgHtml}</td>
                        <td>${receiptBadge}${p.barcode.startsWith('RCP') ? '-' : p.barcode}</td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'name')">${p.name || '-'}</span></td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'brand')">${p.brand || '-'}</span></td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'weight')">${p.weight || '-'}</span></td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'quantity')">${p.quantity}</span></td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'purchase_date')">${p.purchase_date || '-'}</span></td>
                        <td><span class="editable" onclick="editField(this, ${p.id}, 'expiry_date')">${p.expiry_date || '-'}</span></td>
                        <td class="action-btns">
                            <button class="btn btn-danger" onclick="deleteProduct(${p.id})" title="Elimina">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openModal(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('image-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        async function loadExpiring() {
            const data = await fetchJSON('/expiring?days=7');
            const tbody = document.getElementById('expiring-table');
            if (!data.products.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty">Nessun prodotto in scadenza</td></tr>';
                return;
            }
            const today = new Date();
            tbody.innerHTML = data.products.map(p => {
                const exp = new Date(p.expiry_date);
                const days = Math.ceil((exp - today) / (1000*60*60*24));
                let badge = 'badge-success';
                let status = 'OK';
                if (days <= 0) { badge = 'badge-danger'; status = 'SCADUTO'; }
                else if (days <= 3) { badge = 'badge-warning'; status = days + ' giorni'; }
                else { status = days + ' giorni'; }
                return `
                    <tr>
                        <td>${p.barcode}</td>
                        <td>${p.name || '-'}</td>
                        <td>${p.expiry_date}</td>
                        <td><span class="badge ${badge}">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function loadShopping() {
            const data = await fetchJSON('/shopping');
            const tbody = document.getElementById('shopping-table');
            if (!data.shopping_list.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">Lista vuota</td></tr>';
                return;
            }
            tbody.innerHTML = data.shopping_list.map(item => `
                <tr data-id="${item.id}">
                    <td><span class="editable" onclick="editShoppingField(this, ${item.id}, 'name')">${item.name || item.barcode}</span></td>
                    <td><span class="editable" onclick="editShoppingField(this, ${item.id}, 'quantity')">${item.quantity_needed}</span></td>
                    <td class="action-btns">
                        <button class="btn btn-success" onclick="markPurchased(${item.id})" title="Comprato">‚úì</button>
                        <button class="btn btn-danger" onclick="deleteShoppingItem(${item.id})" title="Elimina">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Inline edit per prodotti inventario
        function editField(el, id, field) {
            const currentVal = el.textContent === '-' ? '' : el.textContent;
            const isDate = field === 'expiry_date' || field === 'purchase_date';
            const isNum = field === 'quantity';

            const input = document.createElement('input');
            input.className = 'inline-edit';
            input.type = isDate ? 'date' : (isNum ? 'number' : 'text');
            input.value = currentVal;
            if (isNum) { input.min = '1'; input.style.width = '60px'; }
            if (field === 'weight') { input.placeholder = 'es. 0,250 kg'; input.style.width = '100px'; }

            el.replaceWith(input);
            input.focus();
            input.select();

            const save = async () => {
                const newVal = input.value || (isNum ? '1' : '');
                const data = {};
                data[field] = isNum ? parseInt(newVal) : newVal;
                await fetch(API + '/product/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadInventory();
            };

            input.onblur = save;
            input.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') loadInventory(); };
        }

        // Inline edit per lista spesa
        function editShoppingField(el, id, field) {
            const currentVal = el.textContent;
            const isNum = field === 'quantity';

            const input = document.createElement('input');
            input.className = 'inline-edit';
            input.type = isNum ? 'number' : 'text';
            input.value = currentVal;
            if (isNum) { input.min = '1'; input.style.width = '60px'; }

            el.replaceWith(input);
            input.focus();
            input.select();

            const save = async () => {
                const newVal = input.value || (isNum ? '1' : '');
                const data = {};
                data[field === 'quantity' ? 'quantity_needed' : field] = isNum ? parseInt(newVal) : newVal;
                await fetch(API + '/shopping/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadShopping();
            };

            input.onblur = save;
            input.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') loadShopping(); };
        }

        async function markPurchased(id) {
            await fetch(API + '/shopping/' + id, { method: 'DELETE' });
            loadAll();
        }

        async function deleteProduct(id) {
            if (!confirm('Eliminare questo prodotto?')) return;
            await fetch(API + '/product/' + id, { method: 'DELETE' });
            loadAll();
        }

        async function deleteShoppingItem(id) {
            if (!confirm('Rimuovere dalla lista?')) return;
            await fetch(API + '/shopping/' + id, { method: 'DELETE' });
            loadAll();
        }

        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                barcode: document.getElementById('add-barcode').value,
                name: document.getElementById('add-name').value,
                brand: document.getElementById('add-brand').value,
                expiry_date: document.getElementById('add-expiry').value,
                quantity: parseInt(document.getElementById('add-qty').value) || 1
            };
            await fetch(API + '/manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            e.target.reset();
            document.getElementById('add-qty').value = '1';
            loadAll();
        });

        document.getElementById('shopping-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('shop-name').value,
                barcode: '',
                quantity: parseInt(document.getElementById('shop-qty').value) || 1
            };
            await fetch(API + '/shopping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            e.target.reset();
            document.getElementById('shop-qty').value = '1';
            loadAll();
        });

        function loadAll() {
            loadStats();
            loadInventory();
            loadExpiring();
            loadShopping();
        }

        loadAll();
        setInterval(loadAll, 30000);
    </script>
</body>
</html>
